<!DOCTYPE html>
<!--
Copyright (c) 2003-2014, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.md or http://ckeditor.com/license
-->
<html>
<head>
    <meta charset="utf-8">
    <title>Advanced Editing</title>

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">

    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

    <!--[if IE 7]>
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome-ie7.min.css">
    <![endif]-->

    <style>
        body {
            margin: 100px;
        }
        #editable
        {
            padding: 10px;
            float: left;
        }

        /*#editable p:after {
            content: 'Hello!';
            display: none;
        }

        #editable p:hover:before, #editable p:hover:after {
            display: block;
            position: absolute;
            left: -30px;
        }*/

        #add-wrapper {
            position: absolute;
        }

        #add-wrapper button {
            padding: 0;
            width: 20px;
            height: 20px;
        }

        /* Hide overlay markup while loading, if js is enabled */
        .yui3-js-enabled .yui3-overlay-loading {
            top: -1000em;
            left: -1000em;
            position: absolute;
        }
        /* Overlay Look/Feel */
        .yui3-overlay-content {
            background-color: #ECEFFB;
            border: 1px solid #9EA8C6;
            border-radius: 3px;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.25);
        }

        .yui3-overlay-content .yui3-widget-hd {
            background-color: #B6BFDA;
            color: #30418C;
            font-size: 120%;
            font-weight: bold;
            padding: 0.2em 0.5em 0.3em;
            border-radius: 2px 2px 0 0;
        }

        .yui3-overlay-content .yui3-widget-bd {
            padding: 0.4em 0.6em 0.5em;
        }

        .yui3-overlay-content .yui3-widget-ft {
            background-color:#DFE3F5;
            padding: 0.4em 0.6em 0.5em;
            border-radius: 0 0 2px 2px;
        }

        #add-content {
            position: absolute;
        }

        .input-wrapper {
            margin-left: 0;
        }

        .input-container {
            margin-left: 5px;
            width: 210px;
        }

        .input-clear-container {
            width: 40px;
        }

        #linkInput {
            margin: 5px 0 5px 0px;
            width: 185px;
        }

        #mainButtons {
            margin: 5px;
        }

        .input-clear-container {
            margin-left: -10px;
            margin-top: 5px;
        }

    </style>

    <script src="http://cdn.alloyui.com/2.5.0/aui/aui-min.js"></script>

    <script src="lib/ckeditor/ckeditor.js"></script>
    <script src="dist/selection-region-plugin.js"></script>

    <style>

        #editable
        {
            padding: 10px;
            float: left;
        }

    </style>
</head>
<body>
    <button id="testBtn">Click me!</button>

    <h1 class="samples">
        <a href="index.html">CKEditor Samples</a> &raquo; Inline Editing by Code
    </h1>
    <div class="description">
        <p>
            This sample shows how to create an inline editor instance of CKEditor. It is created
            with a JavaScript call using the following code:
        </p>
<pre class="samples">
// This property tells CKEditor to not activate every element with contenteditable=true element.
CKEDITOR.disableAutoInline = true;

var editor = CKEDITOR.inline( document.getElementById( 'editable' ) );
</pre>
        <p>
            Note that <code>editable</code> in the code above is the <code>id</code>
            attribute of the <code>&lt;div&gt;</code> element to be converted into an inline instance.
        </p>
    </div>
    <div id="editable" contenteditable="true">
        <p id="test123"><b>Apollo 11</b> was the spaceflight that landed the first humans, Americans <a href="http://en.wikipedia.org/wiki/Neil_Armstrong" title="Neil Armstrong">Neil Armstrong</a> and <a href="http://en.wikipedia.org/wiki/Buzz_Aldrin" title="Buzz Aldrin">Buzz Aldrin</a>, on the Moon on July 20, 1969, at 20:18 UTC. Armstrong became the first to step onto the lunar surface 6 hours later on July 21 at 02:56 UTC.</p>

        <p>Armstrong spent about <s>three and a half</s> two and a half hours outside the spacecraft, Aldrin slightly less; and together they collected 47.5 pounds (21.5&nbsp;kg) of lunar material for return to Earth. A third member of the mission, <a href="http://en.wikipedia.org/wiki/Michael_Collins_(astronaut)" title="Michael Collins (astronaut)">Michael Collins</a>, piloted the <a href="http://en.wikipedia.org/wiki/Apollo_Command/Service_Module" title="Apollo Command/Service Module">command</a> spacecraft alone in lunar orbit until Armstrong and Aldrin returned to it for the trip back to Earth.</p>

        <h2>Broadcasting and <em>quotes</em> <a id="quotes" name="quotes"></a></h2>

        <p>Broadcast on live TV to a world-wide audience, Armstrong stepped onto the lunar surface and described the event as:</p>

        <blockquote>
            <p>One small step for [a] man, one giant leap for mankind.</p>
        </blockquote>

        <p>Apollo 11 effectively ended the <a href="http://en.wikipedia.org/wiki/Space_Race" title="Space Race">Space Race</a> and fulfilled a national goal proposed in 1961 by the late U.S. President <a href="http://en.wikipedia.org/wiki/John_F._Kennedy" title="John F. Kennedy">John F. Kennedy</a> in a speech before the United States Congress:</p>

        <blockquote>
            <p>[...] before this decade is out, of landing a man on the Moon and returning him safely to the Earth.</p>
        </blockquote>

        <h2>Technical details <a id="tech-details" name="tech-details"></a></h2>

        <table align="right" border="1" bordercolor="#ccc" cellpadding="5" cellspacing="0" style="border-collapse:collapse;margin:10px 0 10px 15px;">
            <caption><strong>Mission crew</strong></caption>
            <thead>
            <tr>
                <th scope="col">Position</th>
                <th scope="col">Astronaut</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>Commander</td>
                <td>Neil A. Armstrong</td>
            </tr>
            <tr>
                <td>Command Module Pilot</td>
                <td>Michael Collins</td>
            </tr>
            <tr>
                <td>Lunar Module Pilot</td>
                <td>Edwin &quot;Buzz&quot; E. Aldrin, Jr.</td>
            </tr>
            </tbody>
        </table>

        <p>Launched by a <strong>Saturn V</strong> rocket from <a href="http://en.wikipedia.org/wiki/Kennedy_Space_Center" title="Kennedy Space Center">Kennedy Space Center</a> in Merritt Island, Florida on July 16, Apollo 11 was the fifth manned mission of <a href="http://en.wikipedia.org/wiki/NASA" title="NASA">NASA</a>&#39;s Apollo program. The Apollo spacecraft had three parts:</p>

        <img src="http://21stcenturywaves.com/wp-content/uploads/2009/07/fullmoon.thumbnail.jpg">

        <ol>
            <li><strong>Command Module</strong> with a cabin for the three astronauts which was the only part which landed back on Earth</li>
            <li><strong>Service Module</strong> which supported the Command Module with propulsion, electrical power, oxygen and water</li>
            <li><strong>Lunar Module</strong> for landing on the Moon.</li>
        </ol>

        <p></p>

        <p>After being sent to the Moon by the Saturn V&#39;s upper stage, the astronauts separated the spacecraft from it and travelled for three days until they entered into lunar orbit. Armstrong and Aldrin then moved into the Lunar Module and landed in the <a href="http://en.wikipedia.org/wiki/Mare_Tranquillitatis" title="Mare Tranquillitatis">Sea of Tranquility</a>. They stayed a total of about 21 and a half hours on the lunar surface. After lifting off in the upper part of the Lunar Module and rejoining Collins in the Command Module, they returned to Earth and landed in the <a href="http://en.wikipedia.org/wiki/Pacific_Ocean" title="Pacific Ocean">Pacific Ocean</a> on July 24.</p>

        <hr />
        <p style="text-align: right;"><small>Source: <a href="http://en.wikipedia.org/wiki/Apollo_11">Wikipedia.org</a></small></p>
    </div>

    <script>
        CKEDITOR.disableAutoInline = true;

        YUI({
            filter: 'raw'
        }).use('node', 'overlay', 'event-mouseenter', 'aui-debounce', 'aui-toolbar', 'gesture-simulate', 'lao-editor', function(Y) {
            debugger;

            var editor = CKEDITOR.inline('editable');

            window.editor = editor;

            debugger;

            var elements = ['strong', 'em', 'u', 'a', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'img'];

            editor.on('configLoaded', function() {
                editor.config.allowedContent = true;

                // Remove unnecessary plugins to make the editor simpler.
                editor.config.removePlugins = 'contextmenu,toolbar,elementspath,resize,contextmenu,liststyle,tabletools,link';
                editor.config.extraPlugins = 'selectionregion';

                debugger;

                Y.Array.each(
                    elements,
                    function(item, index, array) {
                        var style = new CKEDITOR.style({element: item});
                        elements[index] = {
                            name: item,
                            style: style
                        };
                    }
                );
            });

            function setContentTimeout() {
                window.leaveTimeout = setTimeout(
                    function() {
                        window.addOverlay.hide();
                    },
                    1000
                );
            }

            function showAdd(x, y) {
                window.add.set('xy', [x, y]);

                window.add.show();
            }

            function hideAdd() {
                window.add.hide();
            }

            function showToolbar(left, top, direction) {
                var xy = getToolbarXYPoint(left, top, direction);

                window.overlay.set('xy', xy);

                window.overlay.show();
            }

            function hideToolbar(argument) {
                window.overlay.hide();
            }

            function updateUI() {
                var path = editor.elementPath();

                Y.Array.each(
                    elements,
                    function(item, index, collection) {
                        var result = item.style.checkActive(path, editor);

                        var btnInst = buttons[item.name];

                        if (btnInst) {
                            btnInst.set('pressed', !!result);
                        }
                    }
                );
                // var style = new CKEDITOR.style({element: 'strong'});

                // var result = style.checkActive( editor.elementPath(), editor );

                // console.log('selection has been made bold: ', result);

            }

            function getToolbarXYRegion(selectionData) {
                var bb = overlay.get('boundingBox');

                var selectionWidth = selectionData.region.right - selectionData.region.left;

                var halfSelection = selectionWidth / 2;

                var left = window.editorNode.get('docScrollX') + 10 + selectionData.region.left - bb.getDOMNode().offsetWidth / 2;

                var top = selectionData.region.top + window.editorNode.get('docScrollY') - bb.getDOMNode().offsetHeight;

                return [left + halfSelection, top];
            }

            function getToolbarXYPoint(left, top, direction) {
                //debugger;
                var bb = overlay.get('boundingBox');

                var left = left - bb.getDOMNode().offsetWidth / 2;

                var top = top - bb.getDOMNode().offsetHeight + (direction === 0 ? 40 : 0);

                return [left, top];
            }

            Y.one('#editable').on('dragstart', function(event) {
                console.log('dragstart');
            });

            dropbox = document.querySelector('#editable');
            dropbox.addEventListener('dragenter', dragenter, false);
            dropbox.addEventListener('dragover', dragover, false);
            dropbox.addEventListener('drop', drop, false);

            function dragenter(e) {
                if (Y.UA.ie) {
                    e.stopPropagation();
                    e.preventDefault();
                }
            }

            function dragover(e) {
                if (Y.UA.ie) {
                    e.stopPropagation();
                    e.preventDefault();
                }
            }

            function drop(e) {
                e.stopPropagation();
                e.preventDefault();

                var dt = e.dataTransfer;
                var files = dt.files;

                createSelectionFromPoint(e.clientX, e.clientY);

                handleFiles(files);
            }

            function handleFiles(files) {
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var imageType = /image.*/;

                    if (!file.type.match(imageType)) {
                        continue;
                    }

                    var reader = new FileReader();

                    reader.addEventListener('loadend', function(e, file) {
                        var bin = reader.result;

                        var el = CKEDITOR.dom.element.createFromHtml('<img src="' + bin + '" border="0" title="Hello" >');

                        editor.insertElement(el);
                    });

                    reader.readAsDataURL(file);
                }

                return false;
            }

            var handleUI = Y.debounce(
                function(event) {
                    console.log('handleUI');
                    var selectionEmpty = isSelectionEmpty();

                    var editorNode = window.editorNode.getDOMNode();

                    var selectionData = getSelectionData();

                    // console.log(selectionData);

                    if (selectionData.region) {
                        showAdd(editorNode.offsetLeft - 30, selectionData.region.top);
                    }
                    else {
                        hideAdd();
                        hideToolbar();

                        return;
                    }

                    window.addOverlay.hide();

                    if (selectionEmpty) {
                        console.log('hide toolbar');
                        hideToolbar();
                    }
                    else {
                        console.log('show toolbar');
                        // debugger;

                        var xy;

                        var direction = selectionData.region.direction;

                        if (selectionData.region.startRect.top === selectionData.region.endRect.top) {
                            direction = 1;
                        }

                        if (event.pageX && event.pageY) {
                            x = event.pageX;

                            if (direction === 1) {
                                y = Math.min(event.pageY, selectionData.region.top);
                            }
                            else {
                                y = Math.max(event.pageY, selectionData.region.bottom);
                            }
                        }
                        else {
                            // debugger;
                            x = selectionData.region.left + selectionData.region.width/2;

                            if (direction === 0) {
                                y = selectionData.region.endRect.top;
                            }
                            else {
                                y = selectionData.region.startRect.top;
                            }
                        }

                        showToolbar(x, y, direction);
                    }
                },
                50
            );

            function applyStyle(event) {
                var btnInst = event.target;

                var btnId = btnInst.get('srcNode').get('id');

                var style;

                Y.Array.some(
                    elements,
                    function(item, index) {
                        if (item.name === btnId) {
                            style = item.style;

                            return true;
                        }
                    }
                );

                if (style) {
                    if (btnInst.get('pressed')) {
                        editor.applyStyle(style);
                    }
                    else {
                        editor.removeStyle(style);
                    }
                }
            }

            function handleLink(event) {
                function getSelectedLink(editor) {
                    var selection = editor.getSelection();

                    var selectedElement = selection.getSelectedElement();

                    if (selectedElement && selectedElement.is('a')){
                        return selectedElement;
                    }

                    var range = selection.getRanges()[0];

                    if (range) {
                        range.shrink( CKEDITOR.SHRINK_TEXT );

                        return editor.elementPath(range.getCommonAncestor()).contains('a', 1);
                    }

                    return null;
                }

                function createLink(URI) {
                    var selection = editor.getSelection();

                    var range = selection.getRanges()[0];

                    if (range.collapsed) {
                        var text = new CKEDITOR.dom.text(URI, editor.document);
                        range.insertNode(text);
                        range.selectNodeContents(text);
                    }

                    var style = new CKEDITOR.style({
                        element: 'a',
                        attributes: {
                            href: URI,
                            'data-cke-saved-href': URI
                        }
                    });

                    style.type = CKEDITOR.STYLE_INLINE;
                    style.applyToRange(range, editor);
                    range.select();
                }

                function updateLink(URI) {
                    var element = getSelectedLink(editor);

                    element.setAttributes({
                        href: URI,
                        'data-cke-saved-href': URI
                    });
                }

                function removeLink() {
                    var style = new CKEDITOR.style({
                        alwaysRemoveElement: 1,
                        element: 'a',
                        type: CKEDITOR.STYLE_INLINE
                    });

                    editor.removeStyle(style);
                }

                var btnInst = event.target;

                if (btnInst.get('pressed')) {
                    var selection = editor.getSelection();
                    var ranges = selection.getRanges();

                    Y.one('#mainButtons').addClass('hide');
                    Y.one('#inputWrapper').removeClass('hide');

                    var linkInput = Y.one('#linkInput');
                    linkInput.focus();

                    createLink('/');

                    linkInput.once('blur', function(event) {
                        console.log('blur');
                        // debugger;
                        var link = linkInput.get('value');

                        if (link) {
                            updateLink(link);
                        }
                        else {
                            removeLink();
                        }

                        // debugger;

                        var range = editor.getSelection().getRanges()[0];

                        range.collapse();

                        range.select();
                    });

                    var handler = linkInput.on('keypress', function(event) {
                        if (event.charCode === 13) {
                            handler.detach();

                            window.overlay.hide();

                            // handleUI();
                        }
                    });
                }
                else {
                    removeLink();
                }
            }

            function handleCloseLink() {
                console.log('close link');

                Y.one('#linkInput').set('value');

                window.overlay.hide();

                handleUI();
            }

            var buttons = {
                strong: new Y.ToggleButton({
                    srcNode: '#strong',
                    on: {
                        'click': applyStyle
                    }
                }).render(),

                em: new Y.ToggleButton({
                    srcNode: '#em',
                    on: {
                        'click': applyStyle
                    }
                }).render(),

                u: new Y.ToggleButton({
                    srcNode: '#u',
                    on: {
                        'click': applyStyle
                    }
                }).render(),

                a: new Y.ToggleButton({
                    srcNode: '#a',
                    on: {
                        'click': handleLink
                    }
                }).render()
            };

            Y.one('.input-clear-container').on('click', handleCloseLink);

            window.overlay = new Y.Overlay({
                srcNode:"#overlay",
                visible: false,
                on: {
                    'visibleChange': function(event) {
                        if (!event.newVal) {
                            Y.one('#inputWrapper').addClass('hide');
                            Y.one('#mainButtons').removeClass('hide');

                            console.log('hide toolbar');
                        }
                        else {
                            Y.one('#linkInput').set('value', '');
                        }
                    }
                }
            }).render();

            window.add = new Y.Overlay({
                srcNode:"#add-wrapper",
                visible: false,
                height: '20px',
                width: '20px'
            }).render();

            Y.one('#add-wrapper').on(['mouseenter', 'click'], function(event) {
                var xy = window.add.get('xy');

                window.clearTimeout(window.leaveTimeout);

                window.addOverlay.show();

                window.addOverlay.set('xy', [xy[0] + 20, xy[1]]);
            });

            Y.one('#add-wrapper').on('mouseleave', function(event) {
                setContentTimeout();
            });

            Y.one('#add-content').on('mouseleave', function(event) {
                setContentTimeout();
            });

            Y.one('#add-content').on('mouseenter', function(event) {
                window.clearTimeout(window.leaveTimeout);
            });

            window.addOverlay = new Y.Overlay({
                srcNode: '#add-content',
                visible: false
            }).render();

            window.editorNode = Y.one('#editable');

            window.editorNode.on('mouseup', handleUI);
            window.editorNode.on('keyup', handleUI);

            Y.one('#testBtn').on('click', function() {
                var caretXY = getCaretXY();

                // console.log(caretXY);
            });
        });
    </script>


    <div id="overlay" class="btn-group">
        <div id="mainButtons">
            <button id="strong" class="btn"><i class="icon-bold"></i></button>
            <button id="em" class="btn"><i class="icon-italic"></i></button>
            <button id="u" class="btn"><i class="icon-underline"></i></button>
            <button id="a" class="btn"><i class="icon-link"></i></button>
        </div>

        <div id="inputWrapper" class="row input-wrapper hide">
            <div class="span10 input-container">
                <input class="input-large" id="linkInput" type="text" placeholder="Type or paste link here">
            </div>
            <div class="span2 input-clear-container">
                <button id="removeLink" class="btn"><i class="icon-remove"></i></button>
            </div>
        </div>
    </div>


    <div id="add-wrapper" class="btn-group">
      <button id="Add" type="button" class="btn btn-default">+</button>
    </div>

    <div id="add-content">
      <div class="btn-group btn-group-vertical">
            <button id="addImage" type="button" class="btn btn-default">Image</button>
            <button id="addCode" type="button" class="btn btn-default">Code</button>
            <button id="addHorizontalLine" type="button" class="btn btn-default">Hor line</button>
      </div>
    </div>

    <div id="footer">
        <hr>
        <p contenteditable="true">
            CKEditor - The text editor for the Internet - <a class="samples" href="http://ckeditor.com/">
                http://ckeditor.com</a>
        </p>
        <p id="copy">
            Copyright &copy; 2003-2014, <a class="samples" href="http://cksource.com/">CKSource</a>
            - Frederico Knabben. All rights reserved.
        </p>
    </div>
</body>
</html>
